# -*- sh -*-
bindkey "^?" backward-delete-char
bindkey "[3~" backward-delete-char
setopt ignoreeof

REPORTTIME=10

export RUBYLIB="${RUBYLIB}":/usr/local/lib/site_ruby
export PATH=$HOME/bin:"${PATH}"
#export PATH=~/.gems/bin:"${PATH}"
#export PATH=~/jruby-1.0/bin:"${PATH}"
#export GEM_HOME=~/.gems
export HREF_DATADIR=~/.href
export EDITOR=vim

alias gosh="rlwrap gosh"
alias g="goruby -rirb -e'IRB.start'"
alias ec=emacsclient
alias ecc="ec -c"
alias ecn="ec -nw"

function svn() {
  if [ $1 = "diff" ] ; then
    command env LANG=C LC_ALL=C svn diff $2 $3 $4 $5 $6
  else
    command svn $*
  fi
}

function say() {
  echo "(SayText \"$*\")"| festival --pipe
}

function reload() {
  source ~/.zshrc
}

autoload -Uz vcs_info
zstyle ':vcs_info:*' formats '(%s)-[%b]'
zstyle ':vcs_info:*' actionformats '(%s)-[%b|%a]'

typeset -ga chpwd_functions
typeset -ga preexec_functions
function _set_rprompt_vcs() {
  LANG=C vcs_info >&/dev/null
  if [ -n "${vcs_info_msg_0_}" ]; then
    RPROMPT="${DEFAULT_RPROMPT}:%{${fg[green]}%}${vcs_info_msg_0_}%{${reset_color}%}"
  else
    RPROMPT=$DEFAULT_RPROMPT
  fi
}
chpwd_functions+=_set_rprompt_vcs
preexec_functions+=_set_rprompt_vcs

function _set_prompt_ruby() {
    local ruby_version
    ruby_version=$(rbenv version | cut -d" " -f1)
    if [ $? != '0' ]; then
        PROMPT=$DEFAULT_PROMPT
    else
        PROMPT="%{${fg[green]}%}${ruby_version}%{${reset_color}%}"$'\n'"${DEFAULT_PROMPT}"
    fi
}
preexec_functions+=_set_prompt_ruby

completion_list () {
  mkdir -p ~/.zsh/completion
  if [ ! -f ~/.zsh/completion/$*[-1] ]; then
    eval $*[1,-2] | sed -e 's/^/compadd /g' > ~/.zsh/completion/$*[-1]
  fi

  `cat ~/.zsh/completion/$*[-1]`
}

_cheat () {
  completion_list 'cheat sheets | grep -v All' _cheat
}

compdef _cheat cheat

_rake () {
  if [ -f Rakefile ]; then
    compadd `rake -T | awk "{print \\$2}" | xargs`
  fi
}

compdef _rake rake

## load private .zshrc configuration file
#
[ -f ~/dotfiles/zshrc.private ] && source ~/dotfiles/zshrc.private

# load notify.zsh
[ -f $HOME/dotfiles/notify.zsh ] && source $HOME/dotfiles/notify.zsh

# load rbenv
export PATH="$HOME/.rbenv/bin:$PATH"
eval "$(rbenv init -)"
source $HOME/.rbenv/completions/rbenv.zsh
export RUBY_CONFIGURE_OPTS="--enable-shared --disable-install-doc"

## load dir_colors
DIRCOLORS=$HOME/src/dircolors-solarized/dircolors.ansi-universal
test -s $DIRCOLORS && eval $(dircolors $DIRCOLORS)

fpath=(~/.zsh/Completion $fpath)
